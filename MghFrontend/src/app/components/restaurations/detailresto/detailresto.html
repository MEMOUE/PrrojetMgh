<!-- État chargement -->
<div *ngIf="loading" class="loading-container">
  <i class="pi pi-spin pi-spinner" style="font-size: 3rem; color: #6366f1"></i>
  <p>Chargement de la commande...</p>
</div>

<!-- État erreur / commande introuvable -->
<div *ngIf="!loading && !commande" class="loading-container">
  <i class="pi pi-exclamation-circle" style="font-size: 3rem; color: #e74c3c"></i>
  <p>Commande introuvable ou erreur de chargement.</p>
  <button pButton label="Retour à la liste" icon="pi pi-arrow-left"
          class="p-button-outlined mt-3" (click)="retourListe()">
  </button>
</div>

<!-- Contenu principal -->
<div class="detail-commande-container" *ngIf="!loading && commande">
  <p-toast></p-toast>
  <p-confirmDialog></p-confirmDialog>

  <!-- En-tête -->
  <div class="header-section">
    <div class="header-content">
      <div class="header-left">
        <button pButton icon="pi pi-arrow-left" class="p-button-text p-button-sm"
                (click)="retourListe()">
        </button>
        <div>
          <h2>Commande {{ commande.numeroCommande || ('#' + commande.id) }}</h2>
          <p class="subtitle">Créée le {{ commande.dateCommande | date: 'dd/MM/yyyy à HH:mm' }}</p>
        </div>
      </div>
      <div class="header-right">
        <p-tag
          [value]="getStatutLabel(commande.statut)"
          [severity]="getStatutSeverity(commande.statut)">
        </p-tag>
      </div>
    </div>
  </div>

  <!-- Actions rapides -->
  <div class="quick-actions" *ngIf="commande.statut !== 'PAYEE' && commande.statut !== 'ANNULEE'">
    <button pButton label="En Préparation" icon="pi pi-cog" class="p-button-info"
            *ngIf="canPasserEnPreparation()" (click)="passerEnPreparation()">
    </button>
    <button pButton label="Prête" icon="pi pi-check-circle" class="p-button-success"
            *ngIf="canMarquerPrete()" (click)="marquerPrete()">
    </button>
    <button pButton label="Servie" icon="pi pi-send" class="p-button-primary"
            *ngIf="canMarquerServie()" (click)="marquerServie()">
    </button>
    <button pButton label="Enregistrer Paiement" icon="pi pi-money-bill" class="p-button-help"
            *ngIf="canAjouterPaiement()" (click)="ajouterPaiement()">
    </button>
    <button pButton label="Marquer Payée" icon="pi pi-check" class="p-button-success"
            *ngIf="canMarquerPayee()" (click)="marquerPayee()">
    </button>
    <button pButton label="Imprimer" icon="pi pi-print" class="p-button-secondary"
            (click)="imprimer()">
    </button>
  </div>

  <div class="content-grid">

    <!-- Informations Commande -->
    <p-card header="Informations de la Commande">
      <div class="info-grid">

        <div class="info-item">
          <span class="info-label"><i class="pi pi-hashtag"></i> Numéro de Commande</span>
          <span class="info-value">{{ commande.numeroCommande || ('#' + commande.id) }}</span>
        </div>

        <div class="info-item">
          <span class="info-label"><i class="pi pi-user"></i> Client</span>
          <span class="info-value">{{ getClientDisplay() }}</span>
          <span *ngIf="commande.telephoneClientExterne" class="info-subvalue">
            {{ commande.telephoneClientExterne }}
          </span>
        </div>

        <div class="info-item" *ngIf="commande.numeroTable">
          <span class="info-label"><i class="pi pi-table"></i> Table</span>
          <span class="info-value">{{ commande.numeroTable }}</span>
        </div>

        <div class="info-item" *ngIf="commande.serveurNom">
          <span class="info-label"><i class="pi pi-user-edit"></i> Serveur</span>
          <span class="info-value">{{ commande.serveurNom }}</span>
        </div>

        <div class="info-item">
          <span class="info-label"><i class="pi pi-clock"></i> Date de Commande</span>
          <span class="info-value">{{ commande.dateCommande | date: 'dd/MM/yyyy à HH:mm' }}</span>
        </div>

        <div class="info-item" *ngIf="commande.dateService">
          <span class="info-label"><i class="pi pi-send"></i> Date de Service</span>
          <span class="info-value">{{ commande.dateService | date: 'dd/MM/yyyy à HH:mm' }}</span>
        </div>

      </div>

      <div *ngIf="commande.notes" class="notes-section">
        <h4>Notes</h4>
        <p>{{ commande.notes }}</p>
      </div>
    </p-card>

    <!-- Paiement -->
    <p-card header="Informations de Paiement" class="payment-card">
      <div class="payment-summary">
        <div class="payment-line">
          <span>Montant Total :</span>
          <strong>{{ (commande.montantTotal || 0).toLocaleString('fr-FR') }} FCFA</strong>
        </div>
        <div class="payment-line">
          <span>Montant Payé :</span>
          <strong class="text-success">{{ (commande.montantPaye || 0).toLocaleString('fr-FR') }} FCFA</strong>
        </div>
        <div class="payment-line total-line">
          <span>Montant Restant :</span>
          <strong [class.text-danger]="getMontantRestant() > 0">
            {{ getMontantRestant().toLocaleString('fr-FR') }} FCFA
          </strong>
        </div>
      </div>

      <div *ngIf="getMontantRestant() === 0" class="payment-complete">
        <i class="pi pi-check-circle"></i>
        <span>Paiement complet</span>
      </div>
      <div *ngIf="getMontantRestant() > 0" class="payment-pending">
        <i class="pi pi-exclamation-circle"></i>
        <span>Paiement incomplet</span>
      </div>
    </p-card>

    <!-- Détails des Produits -->
    <p-card header="Détails des Produits" class="products-card">

      <!-- Aucune ligne -->
      <div *ngIf="!commande.lignes || commande.lignes.length === 0"
           style="text-align:center;padding:2rem;color:#9ca3af">
        <i class="pi pi-inbox" style="font-size:2rem"></i>
        <p style="margin-top:.5rem">Aucun article dans cette commande</p>
      </div>

      <p-table *ngIf="commande.lignes && commande.lignes.length > 0"
               [value]="commande.lignes"
               styleClass="p-datatable-sm p-datatable-striped">

        <ng-template pTemplate="header">
          <tr>
            <th>Produit</th>
            <th style="width:100px;text-align:center">Qté</th>
            <th style="width:150px;text-align:right">Prix Unitaire</th>
            <th style="width:150px;text-align:right">Sous-total</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-ligne>
          <tr>
            <td>
              <div class="produit-cell">
                <strong>{{ ligne.produitNom || 'Produit #' + ligne.produitId }}</strong>
                <small *ngIf="ligne.notes" class="text-muted" style="display:block;margin-top:2px">
                  ↳ {{ ligne.notes }}
                </small>
              </div>
            </td>
            <td class="text-center">
              <span class="quantity-badge">{{ ligne.quantite }}</span>
            </td>
            <td class="text-right">
              {{ (ligne.prixUnitaire || 0).toLocaleString('fr-FR') }} FCFA
            </td>
            <td class="text-right">
              <strong>
                {{ (ligne.sousTotal ?? (ligne.quantite * (ligne.prixUnitaire || 0))).toLocaleString('fr-FR') }} FCFA
              </strong>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="footer">
          <tr class="total-row">
            <td colspan="3" class="text-right"><strong>MONTANT TOTAL :</strong></td>
            <td class="text-right">
              <strong class="total-amount">
                {{ (commande.montantTotal || 0).toLocaleString('fr-FR') }} FCFA
              </strong>
            </td>
          </tr>
        </ng-template>

      </p-table>
    </p-card>

  </div>
</div>
